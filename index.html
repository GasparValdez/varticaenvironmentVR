<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>VARTICA Metaverse VR | KreaVerse</title>
  <link rel="shortcut icon" href="TemplateData/favicon2.ico?v=2" type="image/x-icon">
  <link rel="stylesheet" href="TemplateData/style.css">
</head>

<body>
  <div id="unity-container">
    <div id="unity-canvas-container">
      <canvas id="unity-canvas"></canvas>
    </div>

    <div id="unity-loading-bar">
      <div id="unity-logo"></div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>

    <div id="unity-footer">
      <div id="unity-webgl-logo"></div>
      <button id="entervr" disabled>Enter VR</button>
      <div id="unity-build-title">VARTICAMetaverse</div>
    </div>
  </div>

  <div class="watermark-image"></div>

  <div id="rotate-warning">
    <div>Por favor, gira tu dispositivo en horizontal / Please, rotate your device horizontally.</div>
  </div>

<script>
/* ================= CONFIG ================= */
var buildUrl = "Build";
var loaderUrl = buildUrl + "/game.loader.js";
var config = {
  dataUrl: buildUrl + "/game.data",
  frameworkUrl: buildUrl + "/game.framework.js",
  codeUrl: buildUrl + "/game.wasm",
  streamingAssetsUrl: "StreamingAssets",
  companyName: "KreaVerse",
  productName: "VARTICAMetaverse",
  productVersion: "3.2",
};

var container = document.querySelector("#unity-container");
var canvas = document.querySelector("#unity-canvas");
var canvasContainer = document.querySelector("#unity-canvas-container");
var loadingBar = document.querySelector("#unity-loading-bar");
var progressBarFull = document.querySelector("#unity-progress-bar-full");
var rotateWarning = document.querySelector("#rotate-warning");
var watermark = document.querySelector(".watermark-image");

var unityInstance = null;
let estaEnVR = false;

/* ================= UI SETUP ================= */
canvasContainer.style.width = "900px";
canvasContainer.style.height = "600px";
loadingBar.style.display = "flex";

/* ================= LOAD UNITY ================= */
var script = document.createElement("script");
script.src = loaderUrl;
script.onload = () => {

  createUnityInstance(canvas, config, (progress) => {
    progressBarFull.style.width = (100 * progress) + "%";
  }).then((instance) => {

    unityInstance = instance;
    loadingBar.style.display = "none";

    /* ========== ACTIVAR VR (SOLO TOUCH) ========== */
    function activarVRDirecto() {
      let btn = document.getElementById("entervr");
      if (!btn || btn.disabled || estaEnVR) return;

      if (!document.fullscreenElement) {
        unityInstance.SetFullscreen(1);
      }

      unityInstance.Module.WebXR.toggleVR();
      estaEnVR = true;
    }

    canvas.addEventListener("touchstart", activarVRDirecto, { passive: true });

    /* ========== BLOQUEAR MOUSE AL DOM (UI SAFE) ========== */
    const eventosMouse = ["mousedown", "mouseup", "click", "dblclick", "contextmenu"];

    eventosMouse.forEach(evt => {
      canvas.addEventListener(evt, (e) => {
        if (estaEnVR) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      }, true);
    });

  }).catch(alert);
};

document.body.appendChild(script);

/* ================= PROTEGER FULLSCREEN ================= */
document.addEventListener("fullscreenchange", () => {
  if (!document.fullscreenElement && estaEnVR && unityInstance) {
    unityInstance.SetFullscreen(1);
  }
});

/* ================= VR EVENTS ================= */
document.addEventListener("onVREnd", () => {
  estaEnVR = false;
});

/* ================= BLUR / FOCUS ================= */
function applyBlur(state) {
  if (state) {
    canvas.classList.add("blurred");
    watermark.classList.add("watermark-active");
  } else {
    canvas.classList.remove("blurred");
    watermark.classList.remove("watermark-active");
  }
}

document.addEventListener("visibilitychange", () => applyBlur(document.hidden));
window.addEventListener("blur", () => applyBlur(true));
window.addEventListener("focus", () => applyBlur(false));

/* ================= ORIENTATION ================= */
function enforceLandscape() {
  const isPortrait = window.innerHeight > window.innerWidth;
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  if (isPortrait && isMobile) {
    rotateWarning.style.display = "flex";
    container.style.display = "none";
  } else {
    rotateWarning.style.display = "none";
    container.style.display = "block";
  }
}

window.addEventListener("resize", enforceLandscape);
enforceLandscape();

/* ================= VR SUPPORT ================= */
document.addEventListener("onVRSupportedCheck", function (event) {
  document.getElementById("entervr").disabled = !event.detail.supported;
});
</script>

</body>
</html>
